<script>
        // ðŸ”‘ ConfiguraÃ§Ãµes Brasil - CORREÃ‡ÃƒO DO ID ZENO FM
        const STREAM_URL = 'https://stream.zeno.fm/olisuxy9v3vtv'; 
        const NOWPLAYING_API = 'https://api.zeno.fm/mounts/metadata/subscribe/olisuxy9v3vtv'; 
        const LASTFM_API_KEY = '7744c8f90ee053fc761e0e23bfa00b89'; 
        
        // Link do logo Brasil no seu GitHub - CAMINHO CORRIGIDO
        const STREAM_LOGO_URL = 'https://raw.githubusercontent.com/webradiosagradafm/radiosagradafm/main/imagem/Logo%20Praise%20FM%20Brasil.png';
        
        // ReferÃªncias aos elementos
        const player = document.getElementById('radioPlayer');
        const playBtn = document.getElementById('playBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const statusText = document.getElementById('status');
        const coverImg = document.getElementById('coverImg');
        const currentTitleEl = document.getElementById('currentTitle');
        const currentDateEl = document.getElementById('currentDate');
        const currentTimeEl = document.getElementById('currentTime');
        const historyList = document.getElementById('historyList');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const showImageEl = document.getElementById('showImage');
        const placeholderIcon = document.getElementById('placeholderIcon');

        let playing = false;
        let currentTrackKey = '';
        const history = [];
        const MAX_HISTORY = 5;
        let currentSong = '';
        let currentArtist = '';

        player.crossOrigin = 'anonymous'; 
        player.src = STREAM_URL;
        
        // GARANTINDO O VOLUME CORRETO
        if (volumeSlider) {
             player.volume = volumeSlider.value;
        } else {
             player.volume = 0.7; 
        }


        function updatePlayButton() {
            playBtn.textContent = playing ? 'â¸ Pausar' : 'â–¶ Play';
            playBtn.setAttribute('aria-label', playing ? 'Pausar rÃ¡dio' : 'Tocar rÃ¡dio');
        }

        // Tenta dar play no inÃ­cio
        player.play().then(() => {
            playing = true;
            updatePlayButton();
            statusText.textContent = 'AO VIVO â€¢ Tocando agora';
        }).catch(err => {
            console.warn('Autoplay bloqueado â€” interaÃ§Ã£o do usuÃ¡rio necessÃ¡ria');
            playing = false; 
            updatePlayButton();
            statusText.textContent = 'Clique em Play para ouvir.';
        });

        playBtn.addEventListener('click', () => {
            if (playing) {
                player.pause();
                statusText.textContent = 'Pausado';
            } else {
                player.play().then(() => {
                    statusText.textContent = 'AO VIVO â€¢ Tocando agora';
                }).catch(err => {
                    statusText.textContent = 'Falha ao tocar â€” tente novamente.';
                    console.error('Play error:', err);
                });
            }
            playing = !playing;
            updatePlayButton();
        });
        
        if (volumeSlider) {
            volumeSlider.addEventListener('input', () => {
                player.volume = volumeSlider.value;
                volumeSlider.setAttribute('aria-valuenow', volumeSlider.value);
                statusText.textContent = `Volume: ${Math.round(player.volume * 100)}%`;
            });
        }


        function updateTime() {
            const now = new Date(); 

            const optionsTime = {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false, 
                timeZone: 'America/Sao_Paulo' /* Fuso HorÃ¡rio Brasil (SÃ£o Paulo) */
            };

            const optionsDate = {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                timeZone: 'America/Sao_Paulo' 
            };
            
            // Usando 'pt-BR' para formataÃ§Ã£o em portuguÃªs
            const timeFormatted = now.toLocaleTimeString('pt-BR', optionsTime);
            const dateFormatted = now.toLocaleDateString('pt-BR', optionsDate);

            currentTimeEl.textContent = timeFormatted;
            currentDateEl.textContent = dateFormatted;
        }

        setInterval(updateTime, 1000);
        updateTime();

        function addToHistory(song, artist, coverUrl = '') {
            const key = `${artist} - ${song}`;
            if (key === currentTrackKey) return;
            currentTrackKey = key;

            const existing = history.findIndex(item => item.song === song && item.artist === artist);
            if (existing !== -1) history.splice(existing, 1);

            history.unshift({ song, artist, coverUrl });

            if (history.length > MAX_HISTORY) history.pop();

            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align:center;color:#666;padding:16px;">Nenhuma mÃºsica ainda...</div>';
                return;
            }

            historyList.innerHTML = history.map(item => {
                const key = `${item.artist} - ${item.song}`;
                const isFavorited = JSON.parse(localStorage.getItem('favorites') || '[]').includes(key) ? 'â˜…' : 'â˜†';
                return `
                    <div class="history-item">
                        <div class="history-img">
                            ${item.coverUrl && item.coverUrl !== STREAM_LOGO_URL ? `<img src="${item.coverUrl}" alt="${item.artist} - ${item.song}">` : '<i class="fas fa-music" style="color:#888;font-size:1.2rem;"></i>'}
                        </div>
                        <div class="history-text">
                            <div class="history-title-item">
                                ${item.song}
                                <span class="favorite-history" data-key="${key}" role="button" tabindex="0" aria-label="Favoritar ${item.artist} - ${item.song}">${isFavorited}</span>
                            </div>
                            <div class="history-artist">${item.artist}</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.favorite-history').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(el.dataset.key, el);
                });
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleFavorite(el.dataset.key, el);
                    }
                });
            });
        }

        function toggleFavorite(key, element = null) {
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const index = favorites.indexOf(key);

            if (index === -1) {
                favorites.push(key);
            } else {
                favorites.splice(index, 1);
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));

            if (key === `${currentArtist} - ${currentSong}`) { 
                favoriteBtn.textContent = index === -1 ? 'â˜…' : 'â˜†';
                favoriteBtn.classList.toggle('favorited', index === -1);
                showImageEl.classList.toggle('favorited-cover', index === -1);
            }

            if (element) {
                element.textContent = index === -1 ? 'â˜…' : 'â˜†'; 
            }

            updateFavoriteButton(); 
        }

        function updateFavoriteButton() {
            if (!currentSong || !currentArtist) return;
            const key = `${currentArtist} - ${currentSong}`; 
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const isFavorited = favorites.includes(key);

            favoriteBtn.textContent = isFavorited ? 'â˜…' : 'â˜†';
            favoriteBtn.classList.toggle('favorited', isFavorited);
            showImageEl.classList.toggle('favorited-cover', isFavorited);
        }

        favoriteBtn.addEventListener('click', () => {
            if (!currentSong || !currentArtist) return;
            const key = `${currentArtist} - ${currentSong}`; 
            toggleFavorite(key);
        });

        favoriteBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (!currentSong || !currentArtist) return;
                const key = `${currentArtist} - ${currentSong}`;
                toggleFavorite(key);
            }
        });

        function isCommercial(title) {
            const keywords = [
                'commercial', 'advertisement', 'sponsor', 'spot', 'publicidade', 'intervalo', 'break', 'jingle', 'comercial', 'anÃºncio', 'patrocÃ­nio'
            ];
            const lower = title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            return keywords.some(k => lower.includes(k));
        }

        function fetchCoverArt(artist, song) {
            if (!artist || !song || isCommercial(song) || artist === 'Praise FM Brasil' || song === 'Ao Vivo') {
                return Promise.resolve(STREAM_LOGO_URL); 
            }
            
            return fetch(
                `https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${LASTFM_API_KEY}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(song)}&format=json`
            )
                .then(res => res.json())
                .then(data => {
                    if (data.track?.album?.image) {
                        const images = data.track.album.image;
                        const cover = images.find(img => img.size === 'extralarge') || images[images.length - 1];
                        return cover['#text'] || '';
                    }
                    return '';
                })
                .catch(err => {
                    console.warn('Failed to fetch cover:', err);
                    return STREAM_LOGO_URL; 
                });
        }

        function isInvalidCover(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(false);
                img.onerror = () => resolve(true);
                img.src = imageUrl;
                setTimeout(() => resolve(true), 5000); 
            });
        }

        function toggleCoverDisplay(showImage = true, imageUrl = '') {
            if (showImage && imageUrl && imageUrl !== STREAM_LOGO_URL) {
                coverImg.src = imageUrl;
                coverImg.style.display = 'block';
                placeholderIcon.style.display = 'none';
            } else {
                coverImg.style.display = 'none';
                placeholderIcon.style.display = 'block';
            }
        }

        function setupNowPlaying() {
            const eventSource = new EventSource(NOWPLAYING_API);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    let streamTitle = (data.streamTitle || '').trim() || 'MÃºsica Desconhecida';

                    streamTitle = streamTitle.replace(/[^\p{L}\p{N}\s\-â€“â€”.,:;!?'"()&@#$%*+=/\\|<>[\]{}~`^_]/gu, ' ').replace(/\s+/g, ' ').trim();

                    if (!streamTitle || streamTitle.length < 3) {
                        streamTitle = 'Praise FM Brasil - Spot';
                    }

                    const isSpot = isCommercial(streamTitle);
                    
                    if (isSpot) {
                        streamTitle = 'Praise FM Brasil - Spot';
                    }
                    
                    const parts = streamTitle.split(' - ').map(p => p.trim()).filter(Boolean);
                    const artist = parts[0] || 'Praise FM Brasil';
                    const song = parts.length > 1 ? parts.slice(1).join(' - ') : streamTitle;

                    currentSong = song;
                    currentArtist = artist;

                    currentTitleEl.textContent = `${artist} - ${song}`;
                    currentTitleEl.title = `${artist} - ${song}`;

                    fetchCoverArt(artist, song).then(coverUrl => {
                        if (!coverUrl || isSpot || coverUrl === STREAM_LOGO_URL) {
                            toggleCoverDisplay(false); 
                            coverImg.alt = isSpot ? 'Comercial' : `${artist} - ${song}`;
                            addToHistory(song, artist, STREAM_LOGO_URL); 

                        } else {
                            isInvalidCover(coverUrl).then(isInvalid => {
                                if (isInvalid) {
                                    toggleCoverDisplay(false); 
                                    coverImg.alt = `${artist} - ${song}`;
                                } else {
                                    toggleCoverDisplay(true, coverUrl); 
                                    coverImg.alt = `${artist} - ${song}`;
                                }
                                addToHistory(song, artist, coverImg.src);
                            }).catch(() => {
                                toggleCoverDisplay(false); 
                                coverImg.alt = `${artist} - ${song}`;
                                addToHistory(song, artist, STREAM_LOGO_URL);
                            });
                        }

                        updateFavoriteButton();

                        statusText.textContent = `AO VIVO â€¢ Tocando: ${artist} - ${song}`;

                        if (isSpot) {
                            statusText.textContent = 'ðŸ“¢ Este Ã© um comercial';
                        }

                    }).catch(err => {
                        console.error("Erro ao buscar capa no Then/Catch principal:", err);
                        toggleCoverDisplay(false); 
                        coverImg.alt = 'Praise FM Brasil - Ao Vivo';
                        currentTitleEl.textContent = 'Praise FM Brasil - Ao Vivo';
                        statusText.textContent = 'AO VIVO â€¢ Ao Vivo';
                    });

                } catch (err) {
                    console.warn('Erro ao analisar metadados', err);
                    currentTitleEl.textContent = 'Praise FM Brasil - Ao Vivo';
                    toggleCoverDisplay(false); 
                    statusText.textContent = 'AO VIVO â€¢ Ao Vivo';
                }
            };

            eventSource.onerror = () => {
                console.warn('EventSource falhou, tentando novamente em 15s...');
                statusText.textContent = 'ConexÃ£o falhou. Tentando novamente...';
                setTimeout(setupNowPlaying, 15000);
            };
        }
        
        toggleCoverDisplay(false); 
        setupNowPlaying();
        updatePlayButton();
    </script>
